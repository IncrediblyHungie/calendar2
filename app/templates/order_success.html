{% extends "base.html" %}

{% block title %}Order Confirmed!{% endblock %}

{% block content %}
<div class="container-figma section-figma" style="background: #ffffff; min-height: 100vh;">
    <div class="row justify-content-center">
        <div class="col-lg-7">
            <!-- Success Header -->
            <div class="text-center mb-lg">
                <div class="mb-md">
                    <i class="fas fa-check-circle" style="font-size: 64px; color: var(--accent-primary);"></i>
                </div>
                <h1 style="font-size: 32px; margin-bottom: var(--spacing-sm); color: #1a1a1a; font-weight: 700;">
                    Order Confirmed! ðŸŽ‰
                </h1>
                <p style="color: #333333; font-size: 16px; margin-bottom: var(--spacing-md);">
                    Your "Hunk of the Month" calendar is being created.
                </p>
                {% if order_id %}
                <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: var(--spacing-sm); display: inline-block;">
                    <strong style="color: #1a1a1a; font-size: 14px;">Order #</strong>
                    <span style="color: var(--accent-primary); font-family: monospace;">{{ order_id }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Delivery Worker Hero Image -->
            <div class="mb-lg">
                <div style="background: linear-gradient(135deg, rgba(247, 62, 151, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border-radius: var(--radius-xl); padding: var(--spacing-lg); text-align: center;">
                    <img id="delivery-worker-image"
                         src="{{ url_for('api.get_delivery_image') }}"
                         alt="Your personal delivery hunky postal worker"
                         style="max-width: 600px; width: 100%; height: auto; border-radius: var(--radius-lg); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); display: none;"
                         onload="this.style.display='block'; document.getElementById('delivery-loading').style.display='none';"
                         onerror="this.style.display='none'; document.getElementById('delivery-loading').style.display='none';">
                    <div id="delivery-loading" style="padding: var(--spacing-xl);">
                        <div style="display: inline-block; width: 60px; height: 60px; border: 6px solid rgba(247, 62, 151, 0.2); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="color: #333333; margin-top: var(--spacing-md); font-size: 16px;">Preparing your delivery preview...</p>
                    </div>
                </div>
            </div>

            <style>
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
            </style>

            <!-- What Happens Next -->
            <div class="mb-lg">
                <h5 style="color: #1a1a1a; margin-bottom: var(--spacing-md); text-align: center; font-weight: 700;">
                    What Happens Next
                </h5>

                <!-- Timeline Cards -->
                <div class="mb-md">
                    <!-- AI Generation -->
                    <div class="step-card mb-md" style="background: #ffffff; border: 1px solid #e9ecef;">
                        <div class="step-icon" style="background: var(--accent-primary);">
                            <i class="fas fa-magic"></i>
                        </div>
                        <div class="step-content">
                            <h6 style="color: #1a1a1a; margin-bottom: 4px; font-weight: 700;">AI Generation</h6>
                            <p style="color: #666666; font-size: 14px; margin: 0;">
                                Our AI is creating your unique calendar with all 12 months, perfect lighting and composition.
                            </p>
                            <small style="color: #999999; font-size: 12px;">~15 minutes</small>
                        </div>
                    </div>

                    <!-- Preview Email -->
                    <div class="step-card mb-md" style="background: #ffffff; border: 1px solid #e9ecef;">
                        <div class="step-icon" style="background: var(--accent-success);">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="step-content">
                            <h6 style="color: #1a1a1a; margin-bottom: 4px; font-weight: 700;">Preview Email</h6>
                            <p style="color: #666666; font-size: 14px; margin: 0;">
                                You'll receive a preview of all 12 months. Approve it or request changes (if needed).
                            </p>
                            <small style="color: var(--accent-success); font-size: 12px; font-weight: 600;">Today</small>
                        </div>
                    </div>

                    <!-- Printing & Shipping -->
                    <div class="step-card" style="background: #ffffff; border: 1px solid #e9ecef;">
                        <div class="step-icon" style="background: var(--accent-purple);">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                        <div class="step-content">
                            <h6 style="color: #1a1a1a; margin-bottom: 4px; font-weight: 700;">Printing & Shipping</h6>
                            <p style="color: #666666; font-size: 14px; margin: 0;">
                                Once approved, your calendar will be professionally printed and shipped. Track shipping in real-time.
                            </p>
                            <small style="color: #999999; font-size: 12px;">3-6 days</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            {% if order_total %}
            <div class="mb-lg" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: var(--radius-lg); padding: var(--spacing-md);">
                <h6 style="color: #1a1a1a; margin-bottom: var(--spacing-md); font-weight: 700;">Order Summary</h6>
                <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-sm);">
                    <span style="color: #666666;">Hunk of the Month Calendar</span>
                    <span style="color: #1a1a1a;">${{ order_price|default('19.99') }}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-sm);">
                    <span style="color: #666666;">Shipping</span>
                    <span style="color: var(--accent-success);">FREE</span>
                </div>
                <hr style="border-color: #dee2e6; margin: var(--spacing-md) 0;">
                <div style="display: flex; justify-content: space-between;">
                    <strong style="color: #1a1a1a;">Total</strong>
                    <strong style="color: var(--accent-primary); font-size: 18px;">${{ order_total|default('19.99') }}</strong>
                </div>
            </div>
            {% endif %}

            <!-- Estimated Delivery -->
            <div class="mb-lg" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: var(--radius-md); padding: var(--spacing-md); text-align: center;">
                <i class="fas fa-calendar-check me-2" style="color: var(--accent-purple);"></i>
                <strong style="color: #1a1a1a;">Estimated Delivery:</strong> <span style="color: #666666;">November 11, 2025</span>
            </div>

            <!-- Questions -->
            <div class="mb-lg" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: var(--radius-lg); padding: var(--spacing-md); text-align: center;">
                <h6 style="color: #1a1a1a; margin-bottom: var(--spacing-sm); font-weight: 700;">Questions?</h6>
                <p style="color: #666666; font-size: 14px; margin-bottom: var(--spacing-sm);">
                    We're here to help! Reach out if you need anything.
                </p>
                <a href="mailto:support@hunkofthemonth.shop" class="btn-figma-secondary" style="text-decoration: none; display: inline-block;">
                    Contact Support
                </a>
            </div>

            <!-- Share the Love -->
            <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: var(--radius-lg); padding: var(--spacing-md); text-align: center;">
                <h6 style="color: #1a1a1a; margin-bottom: var(--spacing-sm); font-weight: 700;">Share the Love</h6>
                <p style="color: #666666; font-size: 14px; margin-bottom: var(--spacing-md);">
                    Know someone else who deserves their own hunky calendar? Get 20% off your next order when a friend makes their first purchase.
                </p>
                <a href="{{ url_for('main.index') }}" class="btn-figma-secondary" style="text-decoration: none; display: inline-block;">
                    Refer a Friend
                </a>
            </div>

            <!-- Reviews Footer -->
            <div class="text-center mt-lg" style="padding: var(--spacing-md) 0; border-top: 1px solid #dee2e6;">
                <p style="color: #999999; font-size: 12px; margin-bottom: 8px;">
                    Join 10,000+ people who've turned their favorites into calendars
                </p>
                <div style="color: var(--accent-warning); font-size: 18px; margin-bottom: 4px;">
                    â˜… â˜… â˜… â˜… â˜…
                </div>
                <small style="color: #999999; font-size: 12px;">
                    4.8/5 from 2,847 reviews
                </small>
            </div>
        </div>
    </div>
</div>

<script>
// Poll for delivery image (generated asynchronously in webhook)
let deliveryImageAttempts = 0;
const maxAttempts = 15; // 30 seconds total (15 attempts Ã— 2 seconds)

function checkDeliveryImage() {
    const img = document.getElementById('delivery-worker-image');
    const loading = document.getElementById('delivery-loading');

    if (!img || deliveryImageAttempts >= maxAttempts) {
        if (loading) loading.style.display = 'none';
        return;
    }

    deliveryImageAttempts++;

    // Try to load the image
    fetch('{{ url_for("api.get_delivery_image") }}')
        .then(response => {
            if (response.ok) {
                // Image is ready! Force reload
                img.src = '{{ url_for("api.get_delivery_image") }}?t=' + Date.now();
            } else if (deliveryImageAttempts < maxAttempts) {
                // Not ready yet, try again in 2 seconds
                setTimeout(checkDeliveryImage, 2000);
            } else {
                // Max attempts reached, hide loading
                if (loading) loading.style.display = 'none';
            }
        })
        .catch(error => {
            if (deliveryImageAttempts < maxAttempts) {
                // Error, but try again
                setTimeout(checkDeliveryImage, 2000);
            } else {
                if (loading) loading.style.display = 'none';
            }
        });
}

// Start checking after page load
window.addEventListener('load', function() {
    setTimeout(checkDeliveryImage, 1000); // Wait 1 second before first check
});
</script>

{% endblock %}

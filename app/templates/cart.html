{% extends "base.html" %}

{% block title %}Shopping Cart{% endblock %}

{% block content %}
<div class="container py-5">
    <h1 class="text-center mb-5 text-dark">
        <i class="fas fa-shopping-cart text-primary me-2"></i>
        Your Shopping Cart
    </h1>

    {% if cart_items %}
    <!-- Cart Items -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-body p-4">
                    <h4 class="card-title mb-4">Cart Items ({{ cart_items|length }})</h4>

                    {% for item in cart_items %}
                    <div class="cart-item mb-4 pb-4 border-bottom" data-item-id="{{ item.id }}">
                        <div class="row align-items-center">
                            <!-- Product Image (Printify Mockup) -->
                            <div class="col-md-3">
                                {% set mockup_url = None %}
                                {% if preview_mockups and item.product_type in preview_mockups %}
                                    {% set mockup_data = preview_mockups[item.product_type] %}
                                    {% set mockup_images = mockup_data.mockup_images %}
                                    {# Wall Calendar: mockup #2 (index 1), Desktop: mockup #9 (index 8) #}
                                    {% set mockup_index = 1 if item.product_type == 'wall_calendar' else 8 %}
                                    {% if mockup_images and mockup_index < mockup_images|length %}
                                        {% set mockup_url = mockup_images[mockup_index].src %}
                                    {% elif mockup_images %}
                                        {% set mockup_url = mockup_images[0].src %}
                                    {% endif %}
                                {% endif %}

                                {% if mockup_url %}
                                <!-- Display Printify-generated mockup (preferred) -->
                                <img src="{{ mockup_url }}"
                                     class="img-fluid rounded"
                                     alt="Calendar Mockup"
                                     style="max-height: 200px; object-fit: contain;">
                                {% elif item.has_cover_image %}
                                <!-- Fallback to cover image if mockup not available -->
                                <img src="{{ url_for('api.get_cart_project_cover', project_id=item.project_id) }}"
                                     class="img-fluid rounded"
                                     alt="Calendar Preview"
                                     style="max-height: 200px; object-fit: cover;">
                                {% else %}
                                <!-- Fallback placeholder -->
                                <div class="bg-light rounded d-flex align-items-center justify-content-center"
                                     style="height: 200px;">
                                    <i class="fas fa-calendar-alt fa-3x text-muted"></i>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Product Details -->
                            <div class="col-md-6">
                                <h5 class="mb-2 text-dark">
                                    {% if item.product_type == 'wall_calendar' %}
                                    Wall Calendar 2026
                                    {% elif item.product_type == 'desktop' %}
                                    Custom Desktop Calendar
                                    {% else %}
                                    Unknown Product
                                    {% endif %}
                                </h5>
                                <p class="text-muted mb-1">
                                    <small>
                                        {% if item.product_type == 'wall_calendar' %}
                                        10.8" × 8.4" • 270gsm semi-glossy paper, wire binding
                                        {% elif item.product_type == 'desktop' %}
                                        10" × 5" • 250gsm matte paper, spiral binding
                                        {% else %}
                                        Contact support
                                        {% endif %}
                                    </small>
                                </p>
                                <p class="text-muted mb-0">
                                    <small>
                                        <i class="fas fa-clock me-1"></i>
                                        Created: {{ item.project_created_at[:10] }}
                                    </small>
                                </p>
                            </div>

                            <!-- Price and Actions -->
                            <div class="col-md-3 text-end">
                                <h4 class="text-primary mb-3">
                                    <del class="text-muted">${{ "%.2f"|format(30.00 if item.price == 22.50 else 35.33) }}</del>
                                    ${{ "%.2f"|format(item.price) }}
                                    <small class="text-success d-block">(25% off)</small>
                                </h4>
                                <button class="btn btn-sm btn-outline-danger remove-item-btn"
                                        data-item-id="{{ item.id }}">
                                    <i class="fas fa-trash me-1"></i>Remove
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Continue Shopping -->
            <div class="text-center mb-4">
                <a href="{{ url_for('projects.create_another') }}" class="btn btn-outline-secondary btn-lg">
                    <i class="fas fa-plus-circle me-2"></i>
                    Create Another Calendar
                </a>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="card shadow-lg sticky-top" style="top: 20px;">
                <div class="card-body p-4">
                    <h4 class="card-title mb-4">Order Summary</h4>

                    <div class="d-flex justify-content-between mb-3">
                        <span>Items ({{ cart_items|length }})</span>
                        <span>${{ "%.2f"|format(cart_total) }}</span>
                    </div>

                    <div class="d-flex justify-content-between mb-3">
                        <span>Shipping</span>
                        <span class="text-success">FREE</span>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between mb-4">
                        <strong>Total</strong>
                        <strong class="text-primary">${{ "%.2f"|format(cart_total) }}</strong>
                    </div>

                    <button id="checkout-btn" class="btn btn-success btn-lg w-100 mb-3">
                        <i class="fas fa-lock me-2"></i>
                        Proceed to Checkout
                    </button>

                    <button id="clear-cart-btn" class="btn btn-outline-secondary btn-sm w-100">
                        <i class="fas fa-trash me-2"></i>
                        Clear Cart
                    </button>

                    <p class="text-muted mt-4 mb-0 small text-center">
                        <i class="fas fa-shield-alt me-1"></i>
                        Secure payment via Stripe
                    </p>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Empty Cart -->
    <div class="text-center py-5">
        <i class="fas fa-shopping-cart fa-5x text-muted mb-4"></i>
        <h3 class="mb-3">Your cart is empty</h3>
        <p class="lead text-muted mb-4">
            Create a custom calendar to get started!
        </p>
        <a href="{{ url_for('main.index') }}" class="btn btn-primary btn-lg">
            <i class="fas fa-home me-2"></i>
            Back to Home
        </a>
    </div>
    {% endif %}
</div>

<script>
// Remove item from cart
document.querySelectorAll('.remove-item-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const itemId = this.dataset.itemId;
        const cartItem = document.querySelector(`.cart-item[data-item-id="${itemId}"]`);

        // Show loading
        const originalHTML = this.innerHTML;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        this.disabled = true;

        try {
            const response = await fetch(`/api/cart/remove/${itemId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                // Remove item from DOM
                cartItem.remove();

                // Reload page if cart is now empty
                if (data.cart_count === 0) {
                    window.location.reload();
                } else {
                    // Update totals (simplified - reload for now)
                    window.location.reload();
                }
            } else {
                alert('Error: ' + (data.error || 'Failed to remove item'));
                this.innerHTML = originalHTML;
                this.disabled = false;
            }
        } catch (error) {
            console.error('Remove item error:', error);
            alert('Failed to remove item. Please try again.');
            this.innerHTML = originalHTML;
            this.disabled = false;
        }
    });
});

// Clear entire cart
{% if cart_items %}
document.getElementById('clear-cart-btn').addEventListener('click', async function() {
    // Show loading
    const originalHTML = this.innerHTML;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Clearing...';
    this.disabled = true;

    try {
        const response = await fetch('/api/cart/clear', {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to clear cart'));
            this.innerHTML = originalHTML;
            this.disabled = false;
        }
    } catch (error) {
        console.error('Clear cart error:', error);
        alert('Failed to clear cart. Please try again.');
        this.innerHTML = originalHTML;
        this.disabled = false;
    }
});

// Checkout cart
document.getElementById('checkout-btn').addEventListener('click', async function() {
    // Show loading
    const originalHTML = this.innerHTML;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Loading...';
    this.disabled = true;

    try {
        const response = await fetch('/api/cart/checkout', {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            // Redirect to Stripe checkout
            console.log('✓ Checkout session created:', data.session_id);
            window.location.href = data.checkout_url;
        } else {
            alert('Error: ' + (data.error || 'Failed to create checkout session'));
            this.innerHTML = originalHTML;
            this.disabled = false;
        }
    } catch (error) {
        console.error('Checkout error:', error);
        alert('Failed to start checkout. Please try again.');
        this.innerHTML = originalHTML;
        this.disabled = false;
    }
});
{% endif %}
</script>
{% endblock %}
